apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config
  namespace: amq-streams-cdc
  labels:
    app.kubernetes.io/part-of: amq-streams-cdc-demo
    app.kubernetes.io/component: mysql
data:
  my.cnf: |
    [mysqld]
    server-id=1
    log_bin=mysql-bin
    binlog_format=ROW
    binlog_row_image=FULL
    expire_logs_days=10
    gtid_mode=ON
    enforce_gtid_consistency=ON
    # Use mysql_native_password for better connector compatibility
    default_authentication_plugin=mysql_native_password
  init.sql: |
    -- Products table that we'll be syncing to PostgreSQL
    CREATE TABLE IF NOT EXISTS products (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        description VARCHAR(512),
        weight DECIMAL(10,2),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    );
    
    -- Alter debezium user to use mysql_native_password for Debezium compatibility
    ALTER USER 'debezium'@'%' IDENTIFIED WITH mysql_native_password BY 'dbz'; -- notsecret - demo value
    
    -- Grant permissions to debezium user for CDC
    GRANT SELECT, RELOAD, SHOW DATABASES, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'debezium'@'%';
    GRANT ALL PRIVILEGES ON inventory.* TO 'debezium'@'%';
    FLUSH PRIVILEGES;
    
    -- Insert initial data
    INSERT INTO products (name, description, weight) VALUES
        ('Widget A', 'A fantastic widget', 1.5),
        ('Gadget B', 'An amazing gadget', 2.3),
        ('Gizmo C', 'A wonderful gizmo', 0.8);

